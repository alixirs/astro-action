name: Astronomer CI - Deploy code

on:
  push:
    branches:
      - main

env:
  ## Set Astro API Token as an environment variable
#  ASTRO_API_TOKEN: ${{ secrets.ASTRO_API_TOKEN }}
  ACTIONS_STEP_DEBUG: true
  ACTIONS_RUNNER_DEBUG: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Astro CLI with deep tracing (user dir, no sudo)
        shell: bash {0}
        run: |
          set -euo pipefail
          PS4='+ (${BASH_SOURCE}:${LINENO}) '
          BIN="$HOME/.local/bin"
          mkdir -p "$BIN"
          DOWNLOADER="https://raw.githubusercontent.com/astronomer/astro-cli/main/godownloader.sh"
          curl -fsSL "$DOWNLOADER" -o /tmp/astro-godownloader.sh
          # Show the first lines so we know what script we're executing
          sed -n '1,200p' /tmp/astro-godownloader.sh
          bash -x /tmp/astro-godownloader.sh -b "$BIN"
          echo "$BIN" >> "$GITHUB_PATH"
          astro version

      - name: Deploy to Astro
        shell: bash {0}
        run: |
          astro deploy cmixd2cgs2jzk01nd2rhs4xe5 --parse
